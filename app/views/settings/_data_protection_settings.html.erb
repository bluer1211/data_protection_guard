<div class="data-protection-settings">
  <fieldset class="box">
    <legend><%= l(:label_general_settings) %></legend>
    <p>
      <label><%= l(:label_enable_sensitive_data_detection) %></label>
      <%= check_box_tag 'settings[enable_sensitive_data_detection]', '1', @settings['enable_sensitive_data_detection'] %>
      <em class="info"><%= l(:text_enable_sensitive_data_detection_info) %></em>
    </p>

    <p>
      <label><%= l(:label_enable_personal_data_detection) %></label>
      <%= check_box_tag 'settings[enable_personal_data_detection]', '1', @settings['enable_personal_data_detection'] %>
      <em class="info"><%= l(:text_enable_personal_data_detection_info) %></em>
    </p>

    <p>
      <label><%= l(:label_log_violations) %></label>
      <%= check_box_tag 'settings[log_violations]', '1', @settings['log_violations'] %>
      <em class="info"><%= l(:text_log_violations_info) %></em>
    </p>

    <p>
      <label><%= l(:label_log_to_database) %></label>
      <%= check_box_tag 'settings[log_to_database]', '1', @settings['log_to_database'] %>
      <em class="info"><%= l(:text_log_to_database_info) %></em>
    </p>

    <p>
      <label><%= l(:label_auto_cleanup_days) %></label>
      <%= number_field_tag 'settings[auto_cleanup_days]', @settings['auto_cleanup_days'], min: 1, max: 365, size: 5 %>
      <em class="info"><%= l(:text_auto_cleanup_days_info) %></em>
    </p>
  </fieldset>

  <fieldset class="box">
    <legend><%= l(:label_actions) %></legend>
    <p>
      <%= link_to l(:button_load_defaults), 
          { controller: 'data_protection', action: 'load_defaults' }, 
          method: :post, 
          class: 'button',
          data: { confirm: l(:text_confirm_load_defaults) },
          title: l(:text_load_defaults_info) %>
      <em class="info"><%= l(:text_load_defaults_info) %></em>
    </p>
  </fieldset>
</div>

<style>
.not-implemented {
  color: #999;
  font-size: 0.9em;
  font-style: italic;
  font-weight: normal;
}
</style>

<%= javascript_tag do %>
  $(document).ready(function() {
    $('#test-pattern-btn').click(function(e) {
      e.preventDefault();
      
      var content = $('#test_content').val();
      var pattern = $('#test_pattern').val();
      
      if (!content || !pattern) {
        alert('<%= l(:text_please_provide_content_and_pattern) %>');
        return;
      }
      
      $.ajax({
        url: '<%= url_for(controller: "data_protection", action: "test_pattern") %>',
        type: 'POST',
        data: {
          content: content,
          pattern: pattern
        },
        success: function(data) {
          if (data.success) {
            var result = '<p><strong>匹配數量:</strong> ' + data.count + '</p>';
            if (data.matches.length > 0) {
              result += '<p><strong>匹配內容:</strong></p><ul>';
              data.matches.forEach(function(match) {
                result += '<li>' + $('<div>').text(match).html() + '</li>';
              });
              result += '</ul>';
            }
            $('#test-result-content').html(result);
          } else {
            $('#test-result-content').html('<p class="error">' + data.error + '</p>');
          }
          $('#test-result').show();
        },
        error: function() {
          $('#test-result-content').html('<p class="error"><%= l(:text_test_failed) %></p>');
          $('#test-result').show();
        }
      });
    });
  });
<% end %>
